<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ø§Ù„Ù…ÙˆØ§ÙÙ‚Ø§Øª Ø§Ù„Ù…Ø¹Ù„Ù‚Ø© - Ø§Ù„Ù…Ù†ØµØ© Ø§Ù„ØªØ¹Ù„ÙŠÙ…ÙŠØ©</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        .card {
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            border: none;
            margin-bottom: 20px;
        }
        .card-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 15px 15px 0 0 !important;
            padding: 20px;
        }
        .approval-card {
            border: 2px solid #f0f0f0;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 15px;
            transition: all 0.3s;
        }
        .approval-card:hover {
            border-color: #667eea;
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.2);
        }
        .btn-approve {
            background: linear-gradient(135deg, #28a745, #20c997);
            color: white;
            border: none;
        }
        .btn-reject {
            background: linear-gradient(135deg, #dc3545, #c82333);
            color: white;
            border: none;
        }
        .btn-approve:hover, .btn-reject:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }
        .navbar {
            background: white;
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            margin-bottom: 30px;
            padding: 15px 20px;
        }
        .payment-proof {
            max-width: 200px;
            border-radius: 10px;
            cursor: pointer;
        }
    </style>
</head>
<body>
    <!-- Navbar -->
    <nav class="navbar">
        <div class="container-fluid">
            <a class="navbar-brand" href="/">
                <i class="fas fa-graduation-cap"></i> Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…
            </a>
            <div class="d-flex gap-2">
                <a href="/" class="btn btn-outline-primary">
                    <i class="fas fa-home"></i> Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©
                </a>
                <a href="/students" class="btn btn-outline-info">
                    <i class="fas fa-users"></i> Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø·Ù„Ø§Ø¨
                </a>
            </div>
        </div>
    </nav>

    <div class="container">
        <!-- Pending Approvals Card -->
        <div class="card">
            <div class="card-header">
                <div class="d-flex justify-content-between align-items-center">
                    <h3 class="mb-0">
                        <i class="fas fa-clock"></i> Ø§Ù„Ù…ÙˆØ§ÙÙ‚Ø§Øª Ø§Ù„Ù…Ø¹Ù„Ù‚Ø©
                    </h3>
                    <span class="badge bg-warning text-dark fs-5">
                        {{ pending_enrollments|length }} Ù…Ø¹Ù„Ù‚
                    </span>
                </div>
            </div>
            <div class="card-body">
                {% if pending_enrollments %}
                    {% for enrollment in pending_enrollments %}
                    <div class="approval-card">
                        <div class="row align-items-center">
                            <div class="col-md-3">
                                <h5 class="mb-1">
                                    <i class="fas fa-user-circle text-primary"></i>
                                    {{ enrollment.user.full_name }}
                                </h5>
                                <small class="text-muted">
                                    <i class="fas fa-id-card"></i> {{ enrollment.user.telegram_id }}
                                </small>
                            </div>
                            <div class="col-md-3">
                                <p class="mb-1">
                                    <strong>Ø§Ù„Ø¯ÙˆØ±Ø©:</strong><br>
                                    {{ enrollment.course_name }}
                                </p>
                                <small class="text-muted">
                                    <i class="fas fa-calendar"></i> 
                                    {{ enrollment.enrolled_at.strftime('%Y-%m-%d %H:%M') if enrollment.enrolled_at else 'N/A' }}
                                </small>
                            </div>
                            <div class="col-md-2">
                                <p class="mb-1">
                                    <strong>Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø¯ÙØ¹:</strong><br>
                                    {% if enrollment.payment_method and ('shap' in enrollment.payment_method.lower() or 'sham' in enrollment.payment_method.lower()) %}
                                        <span class="badge bg-info">Sham Cash</span>
                                    {% elif enrollment.payment_method and 'herm' in enrollment.payment_method.lower() %}
                                        <span class="badge bg-warning">HERM</span>
                                    {% else %}
                                        <span class="badge bg-secondary">{{ enrollment.payment_method or 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯' }}</span>
                                    {% endif %}
                                </p>
                            </div>
                            <div class="col-md-2">
                                {% if enrollment.payment_proof_file_id %}
                                    <img src="https://api.telegram.org/file/bot{{ enrollment.bot_token }}/photos/file_{{ enrollment.payment_proof_file_id }}.jpg" 
                                         class="payment-proof img-thumbnail" 
                                         onclick="showImageFromTelegram('{{ enrollment.bot_token }}', '{{ enrollment.payment_proof_file_id }}')"
                                         alt="Ø¥Ø«Ø¨Ø§Øª Ø§Ù„Ø¯ÙØ¹"
                                         onerror="this.src='data:image/svg+xml,%3Csvg xmlns=%22http://www.w3.org/2000/svg%22 width=%22100%22 height=%22100%22%3E%3Ctext x=%2250%25%22 y=%2250%25%22 text-anchor=%22middle%22 fill=%22%23999%22%3EğŸ“·%3C/text%3E%3C/svg%3E'">
                                    <button class="btn btn-sm btn-info mt-1" onclick="showImageFromTelegram('{{ enrollment.bot_token }}', '{{ enrollment.payment_proof_file_id }}')">
                                        <i class="fas fa-eye"></i> Ø¹Ø±Ø¶
                                    </button>
                                {% else %}
                                    <span class="text-muted">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø¥Ø«Ø¨Ø§Øª</span>
                                {% endif %}
                            </div>
                            <div class="col-md-2">
                                <div class="d-grid gap-2">
                                    <button class="btn btn-approve btn-sm" 
                                            onclick="approveEnrollment('{{ enrollment.user.telegram_id }}', '{{ enrollment.course_id }}', '{{ enrollment.type }}')">
                                        <i class="fas fa-check"></i> Ù‚Ø¨ÙˆÙ„
                                    </button>
                                    <button class="btn btn-reject btn-sm" 
                                            onclick="rejectEnrollment('{{ enrollment.user.telegram_id }}', '{{ enrollment.course_id }}', '{{ enrollment.type }}')">
                                        <i class="fas fa-times"></i> Ø±ÙØ¶
                                    </button>
                                </div>
                            </div>
                        </div>
                        <div class="row mt-2">
                            <div class="col-md-12">
                                <small class="text-muted">
                                    <i class="fas fa-envelope"></i> {{ enrollment.user.email }} |
                                    <i class="fas fa-phone"></i> {{ enrollment.user.phone }}
                                </small>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                {% else %}
                    <div class="text-center text-muted py-5">
                        <i class="fas fa-check-circle fa-4x mb-3 text-success"></i>
                        <h4>Ø±Ø§Ø¦Ø¹! Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…ÙˆØ§ÙÙ‚Ø§Øª Ù…Ø¹Ù„Ù‚Ø©</h4>
                        <p>Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø·Ù„Ø¨Ø§Øª ØªÙ…Øª Ù…Ø¹Ø§Ù„Ø¬ØªÙ‡Ø§</p>
                    </div>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- Image Modal -->
    <div class="modal fade" id="imageModal" tabindex="-1">
        <div class="modal-dialog modal-lg modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Ø¥Ø«Ø¨Ø§Øª Ø§Ù„Ø¯ÙØ¹</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body text-center">
                    <img id="modalImage" src="" class="img-fluid" alt="Ø¥Ø«Ø¨Ø§Øª Ø§Ù„Ø¯ÙØ¹">
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        function showImage(img) {
            document.getElementById('modalImage').src = img.src;
            new bootstrap.Modal(document.getElementById('imageModal')).show();
        }

        async function showImageFromTelegram(botToken, fileId) {
            try {
                // Get file path from Telegram
                const fileResponse = await fetch(`https://api.telegram.org/bot${botToken}/getFile?file_id=${fileId}`);
                const fileData = await fileResponse.json();
                
                if (fileData.ok) {
                    const filePath = fileData.result.file_path;
                    const imageUrl = `https://api.telegram.org/file/bot${botToken}/${filePath}`;
                    
                    document.getElementById('modalImage').src = imageUrl;
                    new bootstrap.Modal(document.getElementById('imageModal')).show();
                } else {
                    alert('âŒ ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙˆØ±Ø© Ù…Ù† Telegram');
                }
            } catch (error) {
                console.error('Error loading image:', error);
                alert('âŒ Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙˆØ±Ø©');
            }
        }

        async function approveEnrollment(telegramId, courseId, enrollmentType) {
            if (!confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ù‚Ø¨ÙˆÙ„ Ù‡Ø°Ø§ Ø§Ù„ØªØ³Ø¬ÙŠÙ„ØŸ')) return;
            
            try {
                // Use the correct endpoint based on enrollment type
                const endpoint = enrollmentType === 'material' 
                    ? `/api/approve-material/${telegramId}/${courseId}`
                    : `/api/approve-course/${telegramId}/${courseId}`;
                
                const response = await fetch(endpoint, {
                    method: 'POST',
                    credentials: 'include'
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const contentType = response.headers.get("content-type");
                if (contentType && contentType.indexOf("application/json") !== -1) {
                    const result = await response.json();
                    alert('âœ… ØªÙ… Ù‚Ø¨ÙˆÙ„ Ø§Ù„ØªØ³Ø¬ÙŠÙ„ Ø¨Ù†Ø¬Ø§Ø­!');
                    location.reload();
                } else {
                    const text = await response.text();
                    console.error('Response is not JSON:', text);
                    alert('âœ… ØªÙ… Ù‚Ø¨ÙˆÙ„ Ø§Ù„ØªØ³Ø¬ÙŠÙ„ Ø¨Ù†Ø¬Ø§Ø­!');
                    location.reload();
                }
            } catch (error) {
                console.error('Error:', error);
                alert('âŒ Ø­Ø¯Ø« Ø®Ø·Ø£: ' + error.message);
            }
        }

        async function rejectEnrollment(telegramId, courseId, enrollmentType) {
            const reason = prompt('ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø³Ø¨Ø¨ Ø§Ù„Ø±ÙØ¶:');
            if (!reason) return;
            
            try {
                // Use the correct endpoint based on enrollment type
                const endpoint = enrollmentType === 'material' 
                    ? `/api/reject-material/${telegramId}/${courseId}`
                    : `/api/reject-course/${telegramId}/${courseId}`;
                
                const response = await fetch(endpoint, {
                    method: 'POST',
                    credentials: 'include',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ reason: reason })
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const contentType = response.headers.get("content-type");
                if (contentType && contentType.indexOf("application/json") !== -1) {
                    const result = await response.json();
                    alert('âœ… ØªÙ… Ø±ÙØ¶ Ø§Ù„ØªØ³Ø¬ÙŠÙ„');
                    location.reload();
                } else {
                    alert('âœ… ØªÙ… Ø±ÙØ¶ Ø§Ù„ØªØ³Ø¬ÙŠÙ„');
                    location.reload();
                }
            } catch (error) {
                console.error('Error:', error);
                alert('âŒ Ø­Ø¯Ø« Ø®Ø·Ø£: ' + error.message);
            }
        }
    </script>
</body>
</html>
